name: Generate Terraform Docs

permissions:
  contents: write

on:
  push:
    branches:
      - main
  pull_request:
    paths:
      - '**/*.tf'
      - '.github/workflows/terraform-docs.yml'

  workflow_dispatch:

jobs:
  terraform-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.6

      - name: Install terraform-docs
        run: |
          curl -sSLo terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.20.0/terraform-docs-v0.20.0-linux-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          sudo mv terraform-docs /usr/local/bin/

      - name: Generate README.md
        run: |
          terraform-docs markdown ./terraform > ./terraform/README.md

      - name: Commit changes (if any)
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git diff --cached --quiet || git commit -m "docs: update README with terraform-docs"
          git push

